<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Analytics - EduBot Admin</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .analytics-card h5 {
            font-weight: 300;
            margin-bottom: 10px;
        }
        .analytics-card .display-4 {
            font-weight: bold;
            font-size: 2.5rem;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        .user-list {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        .user-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .user-item:last-child {
            border-bottom: none;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .date-filters {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-graduation-cap"></i>
                EduBot Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('admin.dashboard') }}">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a class="nav-link" href="#">
                    <i class="fas fa-user"></i> {{ user.username }}
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="fas fa-chart-line text-primary"></i>
                    Chat Analytics
                </h2>
                
                <!-- Date Filters -->
                <div class="date-filters">
                    <h5 class="mb-3">
                        <i class="fas fa-filter"></i>
                        Filter by Date Range
                    </h5>
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}">
                        </div>
                        <div class="col-md-4">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Filter
                            </button>
                            <a href="{{ url_for('admin.chat_analytics') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Clear
                            </a>
                        </div>
                    </form>
                </div>

                <!-- Statistics Cards -->
                <div class="row">
                    <div class="col-lg-3 col-md-6">
                        <div class="analytics-card">
                            <h5>
                                <i class="fas fa-comments"></i>
                                Total Conversations
                            </h5>
                            <div class="display-4">{{ total_conversations }}</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="analytics-card">
                            <h5>
                                <i class="fas fa-users"></i>
                                Active Users
                            </h5>
                            <div class="display-4">{{ active_users_count }}</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="analytics-card">
                            <h5>
                                <i class="fas fa-clock"></i>
                                Avg Response Time
                            </h5>
                            <div class="display-4">{{ avg_response_time }}<small>ms</small></div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="analytics-card">
                            <h5>
                                <i class="fas fa-percentage"></i>
                                Avg Confidence
                            </h5>
                            <div class="display-4">{{ avg_confidence }}%</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="chart-container">
                            <h5 class="mb-3">
                                <i class="fas fa-chart-line"></i>
                                Daily Conversations
                            </h5>
                            <canvas id="dailyChart" height="100"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="chart-container">
                            <h5 class="mb-3">
                                <i class="fas fa-chart-pie"></i>
                                Top Intents
                            </h5>
                            <canvas id="intentsChart" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Second Row of Charts -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="chart-container">
                            <h5 class="mb-3">
                                <i class="fas fa-chart-bar"></i>
                                Hourly Distribution
                            </h5>
                            <canvas id="hourlyChart" height="100"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="user-list">
                            <h5 class="mb-3">
                                <i class="fas fa-star"></i>
                                Most Active Users
                            </h5>
                            {% if active_users %}
                                {% for user_data in active_users %}
                                <div class="user-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ user_data.user.first_name }} {{ user_data.user.last_name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ user_data.user.username }}</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-primary">{{ user_data.message_count }} messages</span>
                                            <br>
                                            <small class="text-muted">Last: {{ user_data.last_chat.strftime('%m/%d %H:%M') }}</small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No active users found in the selected date range.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- View Stats Button -->
                <div class="row mt-4">
                    <div class="col-12 text-center">
                        <div class="analytics-card">
                            <h5>View Conversation Statistics</h5>
                            <p>Get detailed insights into your chatbot's performance and user interactions.</p>
                            <button class="btn btn-light btn-lg" onclick="refreshCharts()">
                                <i class="fas fa-chart-line"></i>
                                View Stats
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Chart data from backend
        const chartData = {{ chart_data | tojson | safe }};
        
        // Daily Conversations Chart
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        const dailyChart = new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: chartData.daily_conversations.labels,
                datasets: [{
                    label: 'Conversations',
                    data: chartData.daily_conversations.data,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // Top Intents Chart
        const intentsCtx = document.getElementById('intentsChart').getContext('2d');
        const intentsChart = new Chart(intentsCtx, {
            type: 'doughnut',
            data: {
                labels: chartData.top_intents.labels,
                datasets: [{
                    data: chartData.top_intents.data,
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#f5576c',
                        '#4facfe', '#00f2fe', '#a8edea', '#fed6e3',
                        '#fce38a', '#f38ba8'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Hourly Distribution Chart
        const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
        const hourlyChart = new Chart(hourlyCtx, {
            type: 'bar',
            data: {
                labels: chartData.hourly_distribution.labels,
                datasets: [{
                    label: 'Messages',
                    data: chartData.hourly_distribution.data,
                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                    borderColor: '#667eea',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // Refresh charts function
        function refreshCharts() {
            // Show a loading message or animation
            alert('Chart data refreshed! This shows the current analytics based on your selected date range.');
        }

        // Auto-refresh every 5 minutes (optional)
        // setInterval(() => {
        //     location.reload();
        // }, 300000);
    </script>
</body>
</html>
